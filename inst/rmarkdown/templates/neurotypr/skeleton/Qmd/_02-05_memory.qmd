## Memory {#sec-memory}

{{< include _02-05_memory_text.qmd >}}

```{r}
#| label: setup-memory
#| include: false

# domain
domains <- c("Memory")

# phenotype
pheno <- "memory"
```

```{r}
#| label: export-memory
#| include: false

# Read the CSV file into a data frame
memory <- readr::read_csv("neurocog.csv")

# Filter the data frame based on certain conditions
# Keep only the rows where 'domain' equals 'domains' and 'z_mean_domain' is not NA
memory <- memory |>
  dplyr::filter(domain %in% domains)

# Select specific columns from the data frame
memory <- memory |>
  dplyr::select(
    test,
    test_name,
    scale,
    raw_score,
    score,
    ci_95,
    percentile,
    range,
    domain,
    subdomain,
    narrow,
    pass,
    verbal,
    timed,
    description,
    result,
    z,
    z_mean_domain,
    z_sd_domain,
    z_mean_subdomain,
    z_sd_subdomain,
    z_mean_narrow,
    z_sd_narrow,
    z_mean_pass,
    z_sd_pass,
    z_mean_verbal,
    z_sd_verbal,
    z_mean_timed,
    z_sd_timed
  )

# Write the 'memory' data frame to a CSV file
# The file name is derived from the 'pheno' variable
readr::write_excel_csv(memory, paste0(pheno, ".csv"), na = "", col_names = TRUE, append = FALSE)
```

```{r}
#| label: data-memory
#| include: false

# Memory scales
scales <- c(
  "CVLT-3 Forced-Choice Recognition Hits",
  "CVLT-3 Total Intrusions",
  "CVLT-3 Total Repetitions",
  "Daily Living Memory Delayed Recall",
  "Daily Living Memory Delayed Recognition",
  "Daily Living Memory Immediate Recall",
  "Daily Living Memory Recall vs. Recognition",
  "Daily Living Memory Retention",
  "Delayed Memory Index",
  "Designs I",
  "Designs II",
  "Figure Drawing Immediate Recall",
  "Figure Drawing Percent Retention",
  "Figure Recall",
  "Immediate Memory Index",
  "List B Correct",
  "List B Free Recall Correct",
  "List Learning Immediate Recall",
  "List Learning Intrusions",
  "List Learning List A Discriminability Index",
  "List Learning List A Immediate Recall",
  "List Learning List A Long Delayed Forced-Choice Recognition False Alarms",
  "List Learning List A Long Delayed Forced-Choice Recognition",
  "List Learning List A Long Delayed Recall",
  "List Learning List A Percent Retention",
  "List Learning List A Recall vs. Recognition Index",
  "List Learning List A Short Delayed Recall",
  "List Learning List A Trial 1 Immediate Recall",
  "List Learning List A Trial 2 Immediate Recall",
  "List Learning List A Trial 3 Immediate Recall",
  "List Learning List B Immediate Recall",
  "List Learning Long Delayed Recall",
  "List Learning Perseverations",
  "List Learning Semantic Clusters",
  "List Learning Short Delayed Recall",
  "List Learning",
  "List Memory Delay Effect",
  "List Memory Interference Effect",
  "List Memory Intrusions",
  "List Memory Learning Effect",
  "List Memory Repetitions",
  "List Memory Total and Delayed Recall",
  "List Memory Total Trials 1-5",
  "List Recall",
  "List Recognition",
  "Logical Memory I",
  "Logical Memory II",
  "Long Delay Cued Recall",
  "Long Delay Free Recall",
  "Long-Delay Cued Recall",
  "Long-Delay Free Recall",
  "Long-Delay Recognition Discriminability",
  "Long-Delay Recognition Response Bias",
  "Medication Instructions Delayed Recall",
  "Medication Instructions Delayed Recognition",
  "Medication Instructions Immediate Recall",
  "Memory Domain",
  "Memory for Designs Content",
  "Memory for Designs Delayed Content",
  "Memory for Designs Delayed Spatial",
  "Memory for Designs Delayed",
  "Memory for Designs Spatial",
  "Memory for Designs",
  "Memory for Faces Delayed",
  "Memory for Faces",
  "Memory Index (MEM)",
  "NAB Memory Index",
  "Name/Address/Phone Delayed Recall",
  "Name/Address/Phone Delayed Recognition",
  "Name/Address/Phone Immediate Recall",
  "Narrative Memory Free and Cued Recall",
  "Narrative Memory Free Recall",
  "Narrative Memory Recall",
  "Narrative Memory Recognition",
  "Recognition Discriminability (d')",
  "Recognition Discriminability Nonparametric",
  "ROCFT Delayed Recall",
  "Sentence Repetition",
  "Shape Learning Delayed Forced-Choice Recognition False Alarms",
  "Shape Learning Delayed Forced-Choice Recognition",
  "Shape Learning Delayed Recognition",
  "Shape Learning Discriminability Index",
  "Shape Learning Immediate Recognition",
  "Shape Learning Percent Retention",
  "Shape Learning Trial 1 Immediate Recognition",
  "Shape Learning Trial 2 Immediate Recognition",
  "Shape Learning Trial 3 Immediate Recognition",
  "Short Delay Cued Recall",
  "Short Delay Free Recall",
  "Short-Delay Cued Recall",
  "Short-Delay Free Recall",
  "Story Learning Delayed Recall",
  "Story Learning Immediate Recall",
  "Story Learning Percent Retention",
  "Story Learning Phrase Unit Delayed Recall",
  "Story Learning Phrase Unit Immediate Recall",
  "Story Learning Phrase Unit Percent Retention",
  "Story Learning Thematic Unit Delayed Recall",
  "Story Learning Thematic Unit Immediate Recall",
  "Story Learning Trial 1 Phrase Unit",
  "Story Learning Trial 1 Thematic Unit",
  "Story Learning Trial 2 Phrase Unit",
  "Story Learning Trial 2 Thematic Unit",
  "Story Memory",
  "Story Recall",
  "Total False Positives",
  "Total Hits",
  "Total Intrusions",
  "Total Repetitions",
  "Trial 1 Correct",
  "Trial 1 Free Recall Correct",
  "Trial 2 Correct",
  "Trial 3 Correct",
  "Trial 4 Correct",
  "Trial 5 Correct",
  "Trial 5 Free Recall Correct",
  "Trials 1-4 Correct",
  "Trials 1-5 Correct",
  "Trials 1-5 Free Recall Correct",
  "Visual Reproduction I",
  "Visual Reproduction II",
  "Word List Interference-Recall",
  "Word List Interference-Repetition"
)

# Filter the data using the filter_data function from the bwu library
# The domain is specified by the 'domains' variable
# The scale is specified by the 'scales' variable
data_memory <- bwu::filter_data(data = memory, domain = domains, scale = scales)
```

```{r}
#| label: text-memory
#| cache: true
#| include: false

# Generate the text for the memory domain
bwu::cat_neuropsych_results(data = data_memory, file = "_02-05_memory_text.qmd")
```

```{r}
#| include: false

#' @title Make Table Using gt Package for Neurocognitive Domains
#' @description Create a table of domain counts using dplyr and gt packages.
#' @importFrom dplyr across mutate group_by summarize arrange select if_else
#' @importFrom gt gt cols_label tab_stub_indent tab_header sub_missing tab_options cols_align tab_source_note gtsave tab_style tab_stubhead tab_caption tab_spanner cell_text cells_body cells_row_groups md tab_footnote opt_vertical_padding
#' @importFrom gtExtras gt_theme_538
#' @importFrom tidyr replace_na
#' @importFrom glue glue
#' @param data File or path to data.
#' @param pheno Phenotype name.
#' @param table_name Name of the table to be saved.
#' @param source_note Source note to be added to the table.
#' @param names Names of the columns.
#' @param title Title of the table.
#' @param tab_stubhead Stubhead of the table.
#' @param caption Caption of the table.
#' @param process_md Process markdown.
#' @param fn_scaled_score Footnote for scaled score.
#' @param fn_standard_score Footnote for standard score.
#' @param fn_t_score Footnote for t score.
#' @param fn_z_score Footnote for z score.
#' @param fn_raw_score Footnote for raw scores.
#' @param grp_standard_score Groups for standard score.
#' @param grp_t_score Groups for t score.
#' @param grp_scaled_score Groups for scaled score.
#' @param grp_z_score Groups for z score.
#' @param grp_raw_score Groups for raw scores.
#' @param dynamic_grp Generalized grouping parameter.
#' @param vertical_padding Vertical padding.
#' @param multiline Multiline footnotes, Default = TRUE.
#' @param ... Additional arguments to be passed to the function.
#' @return A formatted table with domain counts.
#' @rdname tbl_gt
#' @export
tbl_gt <-
  function(
    data,
    pheno = NULL,
    table_name = NULL,
    source_note = NULL,
    names = NULL,
    title = NULL,
    tab_stubhead = NULL,
    caption = NULL,
    process_md = FALSE,
    fn_scaled_score = NULL,
    fn_standard_score = NULL,
    fn_t_score = NULL,
    fn_z_score = NULL,
    fn_raw_score = NULL,
    grp_scaled_score = NULL,
    grp_standard_score = NULL,
    grp_t_score = NULL,
    grp_z_score = NULL,
    grp_raw_score = NULL,
    dynamic_grp = NULL,
    vertical_padding = NULL,
    multiline = TRUE,
    ...
  ) {
    # Create data counts
    data_counts <- data |>
      dplyr::select(test_name, scale, score, percentile, range) |>
      dplyr::mutate(across(
        c(score, percentile),
        ~ tidyr::replace_na(., replace = 0)
      ))

    # Create table
    table <- data_counts |>
      dplyr::mutate(
        score = dplyr::if_else(score == 0, NA_integer_, score),
        percentile = dplyr::if_else(percentile == 0, NA_integer_, percentile),
        test_name = as.character(paste0(test_name)),
        scale = as.character(scale)
      ) |>
      gt::gt(
        rowname_col = "scale",
        groupname_col = "test_name",
        process_md = process_md,
        caption = caption,
        rownames_to_stub = FALSE,
        id = paste0("table_", pheno)
      ) |>
      gt::cols_label(
        test_name = gt::md("**Test**"),
        scale = gt::md("**Scale**"),
        score = gt::md("**Score**"),
        percentile = gt::md("**% Rank**"),
        range = gt::md("**Range**")
      ) |>
      gt::tab_header(title = title) |>
      gt::tab_stubhead(label = tab_stubhead) |>
      gt::sub_missing(missing_text = "--") |>
      # Indent rows except the main index row
      gt::tab_stub_indent(
        rows = scale != "Memory Index (MEM)",
        indent = 2
      ) |>
      # Bold the Memory Index (MEM) row in the stub column
      gt::tab_style(
        style = gt::cell_text(weight = "bold"),
        locations = gt::cells_stub(
          rows = scale == "Memory Index (MEM)"
        )
      ) |>
      gt::cols_align(
        align = "center",
        columns = c("score", "percentile", "range")
      ) # <-- End of pipe chain

    # Add footnotes individually
    if (!is.null(fn_scaled_score)) {
      table <- table |>
        gt::tab_footnote(
          footnote = fn_scaled_score,
          locations = gt::cells_row_groups(groups = grp_scaled_score)
        )
    }
    if (!is.null(fn_standard_score)) {
      table <- table |>
        gt::tab_footnote(
          footnote = fn_standard_score,
          locations = gt::cells_row_groups(groups = grp_standard_score)
        )
    }
    if (!is.null(fn_t_score)) {
      table <- table |>
        gt::tab_footnote(
          footnote = fn_t_score,
          locations = gt::cells_row_groups(groups = grp_t_score)
        )
    }

    # Adding source note and styling
    table <- table |>
      gt::tab_style(
        style = gt::cell_text(size = "small"),
        locations = gt::cells_source_notes()
      ) |>
      gt::tab_source_note(source_note = source_note) |>
      gtExtras::gt_theme_538() |>
      gt::tab_options(
        row_group.font.weight = "bold",
        footnotes.multiline = multiline,
        footnotes.font.size = "small",
        footnotes.sep = "  " # Adjust spacing between footnotes
      ) |>
      gt::opt_vertical_padding(scale = vertical_padding)

    # Save outputs
    gt::gtsave(table, glue::glue("table_{pheno}.png"))
    gt::gtsave(table, glue::glue("table_{pheno}.pdf"))

    return(table)
  }
```

```{r}
#| label: qtbl-memory
#| dev: tikz
#| fig-process: pdf2png
#| include: false

# Set the default engine for tikz to "xetex"
options(tikzDefaultEngine = "xetex")

ordering_list <- c(
  "CVLT-3 Forced-Choice Recognition Hits",
  "CVLT-3 Total Intrusions",
  "CVLT-3 Total Repetitions",
  "Delayed Memory Index",
  "Designs I",
  "Designs II",
  "Figure Recall",
  "Immediate Memory Index",
  # "List B Correct",
  # "List B Free Recall Correct",
  "List Learning Immediate Recall",
  "List Learning Long Delayed Recall",
  "List Learning Short Delayed Recall",
  "List Learning",
  "List Memory Delay Effect",
  "List Memory Interference Effect",
  "List Memory Intrusions",
  "List Memory Learning Effect",
  "List Memory Repetitions",
  "List Memory Total and Delayed Recall",
  "List Memory Total Trials 1-5",
  "List Recall",
  "List Recognition",
  "Logical Memory I",
  "Logical Memory II",
  "Long Delay Cued Recall",
  "Long Delay Free Recall",
  "Long-Delay Cued Recall",
  "Long-Delay Free Recall",
  "Long-Delay Recognition Discriminability",
  "Long-Delay Recognition Response Bias",
  "Memory Domain",
  "Memory for Designs Content",
  "Memory for Designs Delayed Content",
  "Memory for Designs Delayed Spatial",
  "Memory for Designs Delayed",
  "Memory for Designs Spatial",
  "Memory for Designs",
  "Memory for Faces Delayed",
  "Memory for Faces",
  "NAB Memory Index",
  "Narrative Memory Free and Cued Recall",
  "Narrative Memory Free Recall",
  "Narrative Memory Recall",
  "Narrative Memory Recognition",
  "Recognition Discriminability (d')",
  # "Recognition Discriminability Nonparametric",
  "ROCFT Delayed Recall",
  "Sentence Repetition",
  "Short Delay Cued Recall",
  "Short Delay Free Recall",
  "Short-Delay Cued Recall",
  "Short-Delay Free Recall",
  "Story Learning Delayed Recall",
  "Story Learning Immediate Recall",
  # "Story Learning Percent Retention",
  "Story Memory",
  "Story Recall",
  "Total False Positives",
  "Total Hits",
  "Total Intrusions",
  "Total Repetitions",
  "Trial 1 Correct",
  "Trial 1 Free Recall Correct",
  "Trial 2 Correct",
  "Trial 3 Correct",
  "Trial 4 Correct",
  "Trial 5 Correct",
  "Trial 5 Free Recall Correct",
  "Trials 1-4 Correct",
  "Trials 1-5 Correct",
  "Trials 1-5 Free Recall Correct",
  "Visual Reproduction I",
  "Visual Reproduction II",
  "Word List Interference-Recall",
  "Word List Interference-Repetition",
  # NAB
  "Memory Index (MEM)",
  # "List Learning List A Trial 1 Immediate Recall",
  # "List Learning List A Trial 2 Immediate Recall",
  # "List Learning List A Trial 3 Immediate Recall",
  "List Learning List A Immediate Recall",
  # "List Learning List B Immediate Recall",
  "List Learning List A Short Delayed Recall",
  "List Learning List A Long Delayed Recall",
  # "List Learning List A Percent Retention",
  # "List Learning List A Long Delayed Forced-Choice Recognition",
  # "List Learning List A Long Delayed Forced-Choice Recognition False Alarms",
  "List Learning List A Discriminability Index",
  # "List Learning List A Recall vs. Recognition Index",
  # "List Learning Semantic Clusters",
  # "List Learning Perseverations",
  # "List Learning Intrusions",
  # "Shape Learning Trial 1 Immediate Recognition",
  # "Shape Learning Trial 2 Immediate Recognition",
  # "Shape Learning Trial 3 Immediate Recognition",
  "Shape Learning Immediate Recognition",
  "Shape Learning Delayed Recognition",
  # "Shape Learning Percent Retention",
  # "Shape Learning Delayed Forced-Choice Recognition",
  # "Shape Learning Delayed Forced-Choice Recognition False Alarms",
  "Shape Learning Discriminability Index",
  # "Story Learning Trial 1 Phrase Unit",
  # "Story Learning Trial 2 Phrase Unit",
  "Story Learning Phrase Unit Immediate Recall",
  # "Story Learning Thematic Unit Immediate Recall",
  # "Story Learning Trial 1 Thematic Unit",
  # "Story Learning Trial 2 Thematic Unit",
  "Story Learning Phrase Unit Delayed Recall",
  # "Story Learning Thematic Unit Delayed Recall",
  # "Story Learning Phrase Unit Percent Retention",
  "Daily Living Memory Immediate Recall",
  "Daily Living Memory Delayed Recall",
  # "Daily Living Memory Retention",
  "Daily Living Memory Delayed Recognition",
  # "Daily Living Memory Recall vs. Recognition",
  "Medication Instructions Immediate Recall",
  "Medication Instructions Delayed Recall",
  "Medication Instructions Delayed Recognition",
  "Name/Address/Phone Immediate Recall",
  "Name/Address/Phone Delayed Recall",
  "Name/Address/Phone Delayed Recognition"
)

# table arguments
table_name <- "table_memory"
vertical_padding <- 0
multiline <- TRUE

# footnotes
fn_standard_score <- gt::md("Standard score: Mean = 100 [50th‰], SD ± 15 [16th‰, 84th‰]")
fn_scaled_score <- gt::md("Scaled score:  Mean = 10 [50th‰], SD ± 3 [16th‰, 84th‰]")
fn_t_score <- gt::md("T-score: Mean = 50 [50th‰], SD ± 10 [16th‰, 84th‰]")
fn_z_score <- gt::md("Score = z-score (Mean = 0 [50th‰], SD ± 1 [16th‰, 84th‰])")

source_note <- gt::md("_T_ score: Mean = 50 [50th‰], SD ± 10 [16th‰, 84th‰]")

# groupings
grp_memory <- list(
  scaled_score = c("CVLT-3 Brief", "NEPSY-2", "CVLT-C", "CVLT-3", "RBANS Update Form A", "RBANS"),
  standard_score = c("CVLT-3", "CVLT-3 Brief", "NAB", "NAB-S", "CVLT-C", "RBANS Update Form A", "RBANS"),
  t_score = c("Rey Complex Figure", "NAB-S", "NAB Memory", "NAB")
)

# make `gt` table
bwu::tbl_gt(
  data = data_memory,
  pheno = pheno,
  table_name = table_name,
  vertical_padding = vertical_padding,
  # source_note = source_note,
  fn_standard_score = fn_standard_score,
  fn_t_score = fn_t_score,
  fn_scaled_score = fn_scaled_score,
  grp_standard_score = grp_memory[["standard_score"]],
  grp_t_score = grp_memory[["t_score"]],
  grp_scaled_score = grp_memory[["scaled_score"]],
  dynamic_grp = grp_memory,
  multiline = multiline
)
```


```{r}
#| label: fig-memory
#| include: false
#| fig-cap: "Learning and memory refer to the rate and ease with which new information (e.g., facts, stories, lists, faces, names) can be encoded, stored, and later recalled from long-term memory."

# dotplot arguments
x <- data_memory$z_mean_narrow
y <- data_memory$narrow
colors <- NULL
return_plot <- TRUE
filename <- "fig_memory.svg"

# Make dotplot
bwu::dotplot(
  data = data_memory,
  x = x,
  y = y,
  colors = colors,
  return_plot = return_plot,
  filename = filename,
  na.rm = TRUE
)
```

```{=typst}
#let domain(title: none, file_qtbl, file_fig) = {
  let font = (font: "Roboto Slab", size: 0.7em)
  set text(..font)
  pad(top: 0.5em)[]
    grid(
      columns: (50%, 50%),
      gutter: 8pt,
        figure([#image(file_qtbl)],
          caption: figure.caption(position: top, [#title]),
          kind: "qtbl",
          supplement: [Table],
          ),
        figure([#image(file_fig, width: auto)],
          caption: figure.caption(position: bottom,

          [Learning and memory refer to the rate and ease with which new
          information (e.g., facts, stories, lists, faces, names) can be
          encoded, stored, and later recalled from long-term memory.]),

          placement: none,
          kind: "image",
          supplement: [Figure],
          gap: 0.5em,
        ),
      )
  }
```
```{=typst}
#let title = "Learning and Memory"
#let file_qtbl = "table_memory.png"
#let file_fig = "fig_memory.svg"
#domain(
  title: [#title Scores],
  file_qtbl,
  file_fig
)
```
